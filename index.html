<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>个人网站</title>
    <!-- 引入Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- 在Vue.js后引入marked -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link id="theme-css" rel="stylesheet" href="style/default.css">
</head>
<body>
<div id="app">
    <!-- 头部 -->
    <header>
        <h1>{{ config.title || '默认标题' }}</h1>
        <p>{{ config.subtitle || '默认副标题' }}</p>
    </header>
    <!-- 导航 -->
    <nav v-if="currentView === 'list'">
        <ul>
            <li v-for="category in categories"
                :class="{ active: activeCategory === category }"
                @click="filterByCategory(category)">
                {{ category }}
            </li>
        </ul>
    </nav>
    <!-- 返回按钮 -->
    <button v-if="currentView === 'article'" @click="goBackToList" class="back-button">
        ← 返回文章列表
    </button>
    <!-- 文章列表 -->
    <section v-if="currentView === 'list'" id="article-list">
        <div v-for="article in filteredArticles" class="article-card">
            <div class="article-content">
                <h2>
                    <a href="#" @click.prevent="loadAndRenderArticle(article.path)">
                        {{ article.title }}
                    </a>
                </h2>
                <div class="article-meta">
                    <span>{{ article.category }}</span>
                    <span>{{ formatDate(article.lastModified) }}</span>
                </div>
                <p class="article-excerpt">{{ article.excerpt || '点击阅读全文...' }}</p>
                <a href="#" @click.prevent="loadAndRenderArticle(article.path)" class="read-more">阅读全文</a>
            </div>
        </div>
    </section>

    <!-- 分页导航 -->
    <div v-if="currentView === 'list' && totalPages > 1" class="pagination">
        <button @click="setPage(currentPage - 1)" :disabled="currentPage === 1">上一页</button>
        <span v-for="page in totalPages" :key="page">
            <button @click="setPage(page)" :class="{ active: page === currentPage }">
                {{ page }}
            </button>
        </span>
        <button @click="setPage(currentPage + 1)" :disabled="currentPage === totalPages">下一页</button>
    </div>

    <!-- 文章详情 -->
    <section v-if="currentView === 'article'" class="article-detail">
        <div class="article-header">
            <h1>{{ currentArticle.title }}</h1>
            <div class="article-meta-large">
                <span>分类：{{ currentArticle.category }}</span>
                <span>更新：{{ formatDate(currentArticle.lastModified) }}</span>
                <span>作者：{{ config.author || '老韩' }}</span>
            </div>
        </div>
        <div class="markdown-body" v-html="articleContent"></div>
    </section>

    <div class="theme-switcher">
        <button @click="changeTheme('default')">默认蓝</button>
        <button @click="changeTheme('theme-dark')">深空黑</button>
    </div>
    <!-- 页脚 -->
    <footer>
        <p>{{ config.copyright || '© 默认版权' }} |
            <span v-if="config.beian">{{ config.beian }}</span>
        </p>
    </footer>

</div>

<script>

const { Vue } = window;

// 简化 marked 配置
marked.setOptions({
    langPrefix: 'language-'
});

new Vue({
    el: '#app',
    data: {
        articles: [],
        categories: [],
        activeCategory: '首页',
        currentView: 'list',
        articleContent: '',
        currentArticle: {},
        itemsPerPage: 5,
        currentPage: 1,
        config: {}  // 用于存放从 JSON 加载的配置
    },
    computed: {
        filteredArticles() {
            if (this.activeCategory === '首页') {
                return this.articles;
            }
            return this.articles.filter(article => article.category === this.activeCategory);
        },
        paginatedArticles() {
            const start = (this.currentPage - 1) * this.itemsPerPage;
            const end = start + this.itemsPerPage;
            return this.filteredArticles.slice(start, end);
        },
        totalPages() {
            return Math.ceil(this.filteredArticles.length / this.itemsPerPage);
        }
    },
    methods: {
        changeTheme(themeName) {
            console.log("切换主题为:", themeName);
            const themeLink = document.getElementById('theme-css');
            themeLink.href = `style/${themeName}.css`;

            // 可选：保存用户选择的主题
            localStorage.setItem('selectedTheme', themeName);
        },
        goBackToList() {
            this.currentView = 'list';
            window.location.hash = ''; // 清除 hash
        },
        handleHashChange() {
            if (window.location.hash.startsWith('#article/')) {
                const path = decodeURIComponent(window.location.hash.slice(9));
                if (this.articles.length > 0) {
                    this.showArticleByPath(path);
                } else {
                    // 如果文章还未加载完成，等待加载后再处理
                    const checkLoaded = () => {
                        if (this.articles.length > 0) {
                            this.showArticleByPath(path);
                        } else {
                            setTimeout(checkLoaded, 100);
                        }
                    };
                    checkLoaded();
                }
            } else {
                this.currentView = 'list';
            }
        },
        // 通过路径显示文章
        showArticleByPath(path) {
            const article = this.articles.find(a => a.path === path);
            if (!article) {
                alert("文章不存在");
                return;
            }

            fetch(path)
                .then(res => {
                    if (!res.ok) throw new Error("加载失败");
                    return res.text();
                })
                .then(markdown => {
                    this.articleContent = marked.parse(markdown);
                    this.currentArticle = article;
                    this.currentView = 'article'; // ✅ 加上这行
                })
                .catch(err => {
                    console.error("加载失败", err);
                    alert("加载文章内容失败");
                });
        },

        // 原 renderMarkdown 方法改为设置 hash
        renderMarkdown(path) {
            window.location.hash = `article/${encodeURIComponent(path)}`;
        },
        filterByCategory(category) {
            this.activeCategory = category;
            this.currentPage = 1;
        },
        formatDate(date) {
            return new Date(date).toLocaleDateString();
        },
        async loadAndRenderArticle(path) {
            try {
                const response = await fetch(path);
                if (!response.ok) throw new Error(`HTTP 错误! 状态码: ${response.status}`);
                const markdown = await response.text();

                this.articleContent = marked.parse(markdown);
                this.currentArticle = this.articles.find(article => article.path === path);

                // ✅ 先设置 currentView 再改 hash，让页面立刻切换
                this.currentView = 'article';

                // ✅ 设置 hash（用于刷新时恢复）
                window.location.hash = `article/${encodeURIComponent(path)}`;
            } catch (error) {
                console.error('加载文章内容失败:', error);
                alert(`加载文章失败: ${error.message}`);
            }
        },
        async loadConfigAndArticles() {
            try {
                const configRes = await fetch('./config-site.json');
                if (!configRes.ok) throw new Error("加载配置失败");
                const config = await configRes.json();
                this.config = config;
                document.title = config.title;

                const subtitleEl = document.querySelector('header p');
                if (subtitleEl) {
                    subtitleEl.textContent = config.subtitle;
                }
            } catch (error) {
                console.error("加载配置失败:", error);
            }

            try {
                await this.loadArticles(); // 确保文章加载完成后再处理 hash
                this.handleHashChange();
                window.addEventListener('hashchange', this.handleHashChange);
            } catch (error) {
                console.error("加载文章失败:", error);
            }
        },
        async loadArticles() {
            try {
                const response = await fetch('data/article.json');
                const data = await response.json();

                this.articles = data.sort((a, b) =>
                    new Date(b.lastModified) - new Date(a.lastModified)
                );

                const allCategories = [...new Set(data.map(a => a.category))];
                this.categories = ['首页', ...allCategories];
            } catch (error) {
                console.error('加载文章失败:', error);
            }
        },
        setPage(page) {
            if (page >= 1 && page <= this.totalPages) {
                this.currentPage = page;
            }
        }
    },
    mounted() {
        const savedTheme = localStorage.getItem('selectedTheme') || 'default';
        document.getElementById('theme-css').href = `style/${savedTheme}.css`;

        this.loadConfigAndArticles();

        // this.loadArticles().then(() => {
        //     this.handleHashChange();
        //     window.addEventListener('hashchange', this.handleHashChange);
        // });
    }
});
</script>
</body>
</html>